#' @param list_src TBD
#' @param df_twn TBD
#' @param
#' @keywords kh sample size
#' @export
#' @examples
#' \dontrun{
#' kh_df <- get_df(df_ind, df_fam, get_fam=FALSE)
#' }
restrict2sample <- function(df_evn=NULL,
df_ind =NULL,
list_kin =NULL,
array_mat =NULL,
list_src =NULL,
df_twn =NULL,
param = NULL){
included_id <- as.numeric(unlist(lapply(list_kin, lapply, "[[", 1)))
df_evn <- subset(df_evn, id %in% included_id)
df_ind <- subset(df_evn, id %in% included_id)
array_mat <- array_mat[paste(included_id),,]
list_src[[1]] <- subset(list_src[[1]],  id %in% included_id)
list_src[[2]] <- subset(list_src[[2]], doc %in% list_src[[1]]$doc |
doc %in% list_src[[1]]$famnrk1 |
doc %in% list_src[[1]]$famnrk2 |
doc %in% list_src[[1]]$famnrk3 |
doc %in% list_src[[1]]$famnrk4 |
doc %in% list_src[[1]]$famnrk5)
df_twn <- df_twn[df_twn[,1] %in% included_id  & df_twn[,2] %in% included_id,]
return(list("evn" = df_evn, "ind" = df_ind,
"mat" = array_mat, "src"  = list_src,
"twn" = df_twn, "par" = param))
}
out <- restrict2sample(df_evn=kh_evn,
df_ind =kh_ind,
list_kin =kh_kin,
array_mat =kh_mat,
list_src =kh_src,
df_twn =kh_twn,
param = kh_param)
out <- restrict2sample(df_evn=kh_evn,
df_ind =kh_ind,
list_kin =kh_kin,
array_mat =kh_mat[[1]],
list_src =kh_src,
df_twn =kh_twn,
param = kh_param)
out <- restrict2sample(df_evn=kh_evn,
df_ind =kh_ind,
list_kin =kh_kin,
array_mat =kh_mat[[1]],
list_src =kh_src,
df_twn =kh_twn,
param = kh_mat[[2]])
out
kh.data::built_kh(
source_path = "/home/johow/Dropbox/db/kh",
local_path="/home/johow/tmp/kh.data/data",
n = 32, silent=TRUE, set_seed=13)
kh.data::built_kh(
source_path = "/home/johow/Dropbox/db/kh",
local_path="/home/johow/tmp/kh.data/data",
n = 32, silent=TRUE, set_seed=13)
library(kh.data)
list.files(getwd())
list.files(paste(getwd(), "data", sep="/")
)
library(kh.data)
kh.data::built_kh(
source_path = "/home/johow/Dropbox/db/kh",
local_path="/home/johow/tmp/kh.data/data",
n = 32, silent=TRUE, set_seed=13)
knitr::kable(head(kh.data::kh_geo[[1]], 10))
kinlab::plot_pedigree(as.numeric( names(kh.data::kh_ped)[1]), as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1]), kh.data::kh_ind,  kh.data::kh_ped[1], kh.data::kh_mat)
as.numeric( names(kh.data::kh_ped)[1])
as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1])
kinlab::as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1])
kinlab::plot_pedigree(as.numeric( names(kh.data::kh_ped)[1]), kinlab::as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1]), kh.data::kh_ind,  kh.data::kh_ped[1], kh.data::kh_mat)
!Q
kh.data::kh_ind
kh.data::kh_ped[1]
kinlab::plot_pedigree(as.numeric( names(kh.data::kh_ped)[1]), kinlab::as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1]), kh.data::kh_ind,  kh.data::kh_ped[[1]], kh.data::kh_mat)
kh.data::kh_ped[[1]]
library(kinship2)
kinlab::plot_pedigree(as.numeric( names(kh.data::kh_ped)[1]), kinlab::as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1]), kh.data::kh_ind,  kh.data::kh_ped[[1]], kh.data::kh_mat)
kinlab::plot_pedigree
as.numeric(dimnames(kh_mat)$id)
kinlab::plot_pedigree
kinlab::plot_pedigree(as.numeric( names(kh.data::kh_ped)[1]), kinlab::as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1]), kh.data::kh_ind,  kh.data::kh_ped[[1]],
kh.data::kh_mat, as.numeric(dimnames(kh_mat)$id))
kinlab::plot_pedigree(as.numeric( names(kh.data::kh_ped)[1]), kinlab::as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1]), kh.data::kh_ind,  kh.data::kh_ped[[1]],
kh.data::kh_mat)
?kinlab::plot_pedigree
plot_pedigree(40, "1850-01-01", kh_ind, evmat=evmat)
kinlab::plot_pedigree(40, "1850-01-01", kh_ind, evmat=evmat)
Q
kinlab::plot_pedigree
,
get_date(1570, kh_ind)
kinlab::get_date(1570, kh_ind)
kinlab::get_date(1570, kh.data::kh_ind)
kinlab::get_date
kinlab::get_date(1570, kh.data::kh_ind, kh.data::kh_src[[2]])
kinlab::get_date
kinlab::get_date(1570, df_ind = kh.data::kh_ind, df_fam = kh.data::kh_src[[2]])
kh.data::kh_src[[2]]$idf
names(kh.data::kh_src[[2]])
names(kh.data::kh_src
)
kh.data::built_kh(
source_path = "/home/johow/Dropbox/db/kh",
local_path="/home/johow/tmp/kh.data/data",
n = 32, silent=TRUE, set_seed=13)
kinlab::plot_pedigree(as.numeric( names(kh.data::kh_ped)[1]), kinlab::as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1]), kh.data::kh_ind,  kh.data::kh_ped[[1]],
kh.data::kh_mat)
kh_mat[1,,]
kh.data::kh_mat[1,,]
kh.data::kh_ped[1]
kh.data::kh_ped[[1]]
kh.data::kh_ind
str(kh.data::kh_ind)
kinlab::plot_pedigree(as.numeric( names(kh.data::kh_ped)[1]), kinlab::as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1]), as.sata.frame(kh.data::kh_ind),  kh.data::kh_ped[[1]],
kh.data::kh_mat)
kinlab::plot_pedigree(as.numeric( names(kh.data::kh_ped)[1]), kinlab::as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1]), as.data.frame(kh.data::kh_ind),  kh.data::kh_ped[[1]],
kh.data::kh_mat)
names(kh.data::kh_ind)
library(kh.data)
kh.data::built_kh(
source_path = "/home/johow/Dropbox/db/kh",
local_path="/home/johow/tmp/kh.data/data",
n = 32, silent=TRUE, set_seed=13)
kinlab::plot_pedigree(as.numeric( names(kh.data::kh_ped)[1]), kinlab::as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1]), as.data.frame(kh.data::kh_ind),  kh.data::kh_ped[[1]],
kh.data::kh_mat)
kh.data::kh_ind
library(kh.data)
kh.data::built_kh(
source_path = "/home/johow/Dropbox/db/kh",
local_path="/home/johow/tmp/kh.data/data",
n = 32, silent=TRUE, set_seed=13)
kinlab::plot_pedigree(as.numeric( names(kh.data::kh_ped)[1]), kinlab::as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1]), as.data.frame(kh.data::kh_ind),  kh.data::kh_ped[[1]],
kh.data::kh_mat)
kinlab::plot_pedigree(as.numeric( names(kh.data::kh_ped)[1]), kinlab::as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1]), as.data.frame(kh.data::kh_ind),  kh.data::kh_ped[[1]],
kh.data::kh_mat)
kinlab::plot_kinmap
kinlab::plot_kinmap(id=as.numeric( names(kh.data::kh_ped)[1]),
evdat= kinlab::as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1]),
list_kin=kh.data::kh_kin,
list_geo=kh.data::kh_geo,
my_map=kh.data::kh_geo[[2]],
spit_results=FALSE,
throw_plots=TRUE)
kinlab::plot_kinmap(id=as.numeric( names(kh.data::kh_ped)[1]),
evdat= kinlab::as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1]),
list_kin=kh.data::kh_kin,
list_geo=kh.data::kh_geo,
my_map=kh.data::kh_geo[[2]][[1]],
spit_results=FALSE,
throw_plots=TRUE)
test <- kinlab::plot_kinmap(id=as.numeric( names(kh.data::kh_ped)[1]),
evdat= kinlab::as_date(kh.data::kh_mat[names(kh.data::kh_ped)[1],2,1]),
list_kin=kh.data::kh_kin,
list_geo=kh.data::kh_geo,
my_map=kh.data::kh_geo[[2]][[1]],
spit_results=TRUE,
throw_plots=FALSE)
test
kinlab::plot_rrv
y.lim=NULL)
?kinlab::plot_rrv
names(kh_ind)
dimnames(kh_mat)$id
twinmom_id <- kinlab::get_twinmothers(kh_ind, "bdate", "momid")
twinmom_id
kh_ind$twinmother <- ifelse(kh_ind$momid %in% twinmom_id, 1, 0)
df_xs <- data.frame(momid = unique(kh_ind$momid[kh_ind$momid>0]), tmp = NA)
df_xs$twinmother <- ifelse(df_xs$momid %in% twinmom_id, 1, 0)
df_xs
kinlab::plot_rrv(df=df_xs,
momid = "momid",
"twinmother",
kh_ind, kh_mat, kh_mat,
categories=NULL,
action = "make.plot",
y.lim=NULL)
table(kk.data::kh_mat[,1:19,4])
table(kh.data::kh_mat[,1:19,4])
kh_mat2[,2:18,4]
kh_mat2 <- kh_mat
kh_mat2 <- kh.data::kh_mat
kh_mat2[,2:18,4]
test <- paste(kh_mat2[,2:18,4])
test
test <- paste(c(kh_mat2[,2:18,4]))
test
?aste
?paste
test <- paste(c(kh_mat2[,2:18,4]), collapse="")
test
kinlab::get_asfr(kh_ind$momid[kh_ind$momid>0], kh_ind$momid, kh_mat, kh_mat2)
kinlab::get_asfr(kh.data::kh_ind$momid[kh.data::kh_ind$momid>0], kh.data::kh_ind, kh.data::kh_mat, kh.data::kh_mat)
kinlab::get_rrv
kinlab::get_residrvv
kinlab::get_residrv
kinlab::get_resid.rv
kinlab::get_resid_rv
source('~/.active-rstudio-document', echo=TRUE)
c
kh.data::kh_mat
id = as.numeric(names(kh_ped))
df_ped = kh_ind
evmat = kh.data::kh_mat
evmat_bak = kh.data::kh_mat
age = NULL
id = as.numeric(names(kh.data::kh_ped))
df_ped = kh.data::kh_ind
evmat = kh.data::kh_mat
evmat_bak = kh.data::kh_mat
age = 30
cox_survival_f_sample <- survival::coxph(survival::Surv(
ifelse(!is.na(as.numeric(difftime(df_ped$ddate[df_ped$id %in% id],
df_ped$bdate[df_ped$id %in% id], unit="days"))/365.25),
as.numeric(difftime(df_ped$ddate[df_ped$id %in% id],
df_ped$bdate[df_ped$id %in% id], unit="days"))/365.25, 15),
ifelse(!is.na(as.numeric(difftime(df_ped$ddate[df_ped$id %in% id],
df_ped$bdate[df_ped$id %in% id], unit="days"))/365.25),
1, 0)) ~ 1)
tmp_sisters <- na.omit(unlist(lapply(id, get_sisters, df_ped)))
cox_survival_f <- survival::coxph(survival::Surv(
ifelse(!is.na(as.numeric(difftime(df_ped$ddate[df_ped$id %in% tmp_sisters],
df_ped$bdate[df_ped$id %in% tmp_sisters], unit="days"))/365.25),
as.numeric(difftime(df_ped$ddate[df_ped$id %in% tmp_sisters],
df_ped$bdate[df_ped$id %in% tmp_sisters], unit="days"))/365.25, 15),
ifelse(!is.na(as.numeric(difftime(df_ped$ddate[df_ped$id %in% tmp_sisters],
df_ped$bdate[df_ped$id %in% tmp_sisters], unit="days"))/365.25),
1, 0)) ~ 1)
df_asfr <- get_asfr(id, df_ped, evmat, evmat_bak)
df_life <- df_asfr
df_life$age1 <- as.numeric(substr(df_life$age, 1,2))
df_life$age2 <- df_life$age1 + 4
for (i in nrow(df_life)){
df_life$life.exp1[i] <- survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>df_life$age1[i]][1]
df_life$life.exp2[i] <- survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>df_life$age2[i]][1]
}
df_life$life.exp1[1] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>15][1]
df_life$life.exp2[1] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time ==
max(survival::basehaz(cox_survival_f)$time[survival::basehaz(cox_survival_f)$time<20])][1]
df_life$life.exp1[2] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>20][1]
df_life$life.exp2[2] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time ==
max(survival::basehaz(cox_survival_f)$time[survival::basehaz(cox_survival_f)$time<25])][1]
df_life$life.exp1[3] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>25][1]
df_life$life.exp2[3] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time ==
max(survival::basehaz(cox_survival_f)$time[survival::basehaz(cox_survival_f)$time<30])][1]
df_life$life.exp1[4] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>30][1]
df_life$life.exp2[4] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time ==
max(survival::basehaz(cox_survival_f)$time[survival::basehaz(cox_survival_f)$time<35])][1]
df_life$life.exp1[5] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>35][1]
df_life$life.exp2[5] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time ==
max(survival::basehaz(cox_survival_f)$time[survival::basehaz(cox_survival_f)$time<40])][1]
df_life$life.exp1[6] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>40][1]
df_life$life.exp2[6] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time ==
max(survival::basehaz(cox_survival_f)$time[survival::basehaz(cox_survival_f)$time<45])][1]
df_life$life.exp1[7] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>45][1]
df_life$life.exp2[7] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time ==
max(survival::basehaz(cox_survival_f)$time[survival::basehaz(cox_survival_f)$time<50])][1]
df_asfr$life.exp <- (df_life$life.exp1 + df_life$life.exp2)/2
df_asfr$cum.births <- cumsum(df_asfr$nbirth/df_asfr$nwomen)
basehaz_f <- data.frame(time=survival::survfit(cox_survival_f)$time, surv=survival::survfit(cox_survival_f)$surv)
basehaz_f_sample <- data.frame(time=survival::survfit(cox_survival_f_sample)$time, surv=survival::survfit(cox_survival_f_sample)$surv)
basehaz_f_sample$surv <- basehaz_f_sample$surv*min(basehaz_f[basehaz_f$time<15,"surv"])
basehaz_f <- rbind(basehaz_f[basehaz_f$time<min(survival::survfit(cox_survival_f_sample)$time),],basehaz_f_sample)
basehaz_f$rest.births[basehaz_f$time <15] <- sum(df_asfr$nbirth/df_asfr$nwomen)
basehaz_f$rest.births[basehaz_f$time>=15 & basehaz_f$time <20] <- sum(df_asfr$nbirth/df_asfr$nwomen)-df_asfr$nbirth[1]/df_asfr$nwomen[1]
basehaz_f$rest.births[basehaz_f$time>=20 & basehaz_f$time <25] <- sum(df_asfr$nbirth/df_asfr$nwomen)-df_asfr$nbirth[2]/df_asfr$nwomen[2]
basehaz_f$rest.births[basehaz_f$time>=25 & basehaz_f$time <30] <- sum(df_asfr$nbirth/df_asfr$nwomen)-df_asfr$nbirth[3]/df_asfr$nwomen[3]
basehaz_f$rest.births[basehaz_f$time>=30 & basehaz_f$time <35] <- sum(df_asfr$nbirth/df_asfr$nwomen)-df_asfr$nbirth[4]/df_asfr$nwomen[4]
basehaz_f$rest.births[basehaz_f$time>=35 & basehaz_f$time <40] <- sum(df_asfr$nbirth/df_asfr$nwomen)-df_asfr$nbirth[5]/df_asfr$nwomen[5]
basehaz_f$rest.births[basehaz_f$time>=30 & basehaz_f$time <45] <- sum(df_asfr$nbirth/df_asfr$nwomen)-df_asfr$nbirth[6]/df_asfr$nwomen[6]
basehaz_f$rest.births[basehaz_f$time>=45 & basehaz_f$time <50] <- sum(df_asfr$nbirth/df_asfr$nwomen)-df_asfr$nbirth[7]/df_asfr$nwomen[7]
basehaz_f$rest.births[basehaz_f$time >=50] <-0
basehaz_f$surv15 <-
ifelse(basehaz_f$time < 15, basehaz_f$surv[basehaz_f$time>15][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv20<-
ifelse(basehaz_f$time < 20, basehaz_f$surv[basehaz_f$time>20][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv25 <-
ifelse(basehaz_f$time < 25, basehaz_f$surv[basehaz_f$time>25][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv30 <-
ifelse(basehaz_f$time < 30, basehaz_f$surv[basehaz_f$time>30][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv35 <-
ifelse(basehaz_f$time < 35, basehaz_f$surv[basehaz_f$time>35][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv40 <-
ifelse(basehaz_f$time < 40, basehaz_f$surv[basehaz_f$time>40][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv45 <-
ifelse(basehaz_f$time < 45, basehaz_f$surv[basehaz_f$time>45][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv50 <-
ifelse(basehaz_f$time < 50, basehaz_f$surv[basehaz_f$time>50][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv[basehaz_f$time>15][1]
basehaz_f$nbirths.15 <- ifelse(basehaz_f$time < 20,
(ifelse(basehaz_f$time>15, 20-basehaz_f$time, 5))/5 * df_asfr$nbirth[1]/df_asfr$nwomen[1] *
basehaz_f$surv15, 0)
basehaz_f$nbirths.20 <- ifelse(basehaz_f$time < 25,
(ifelse(basehaz_f$time>20, 25-basehaz_f$time, 5))/5 * df_asfr$nbirth[2]/df_asfr$nwomen[2] *
basehaz_f$surv15, 0)
basehaz_f$nbirths.25 <- ifelse(basehaz_f$time < 30,
(ifelse(basehaz_f$time>25, 30-basehaz_f$time, 5))/5 * df_asfr$nbirth[3]/df_asfr$nwomen[3] *
basehaz_f$surv15, 0)
basehaz_f$nbirths.30 <- ifelse(basehaz_f$time < 35,
(ifelse(basehaz_f$time>30, 35-basehaz_f$time, 5))/5 * df_asfr$nbirth[4]/df_asfr$nwomen[4] *
basehaz_f$surv15, 0)
basehaz_f$nbirths.35 <- ifelse(basehaz_f$time < 40,
(ifelse(basehaz_f$time>35, 40-basehaz_f$time, 5))/5 * df_asfr$nbirth[5]/df_asfr$nwomen[5] *
basehaz_f$surv15, 0)
basehaz_f$nbirths.40 <- ifelse(basehaz_f$time < 45,
(ifelse(basehaz_f$time>40, 45-basehaz_f$time, 5))/5 * df_asfr$nbirth[6]/df_asfr$nwomen[6] *
basehaz_f$surv15, 0)
basehaz_f$nbirths.45 <- ifelse(basehaz_f$time < 50,
(ifelse(basehaz_f$time>45, 50-basehaz_f$time, 5))/5 * df_asfr$nbirth[7]/df_asfr$nwomen[7] *
basehaz_f$surv15, 0)
basehaz_f$resid.rv <-apply(basehaz_f[,c("nbirths.15", "nbirths.20",  "nbirths.25",  "nbirths.30",  "nbirths.35",  "nbirths.40",  "nbirths.45")], 1, sum)
basehaz_f$n.surv <-apply(basehaz_f[,c("surv15", "surv20",  "surv25",  "surv30",  "surv35",  "surv40",  "surv45")], 1, sum)
cox_survival_f_sample <- survival::coxph(survival::Surv(
ifelse(!is.na(as.numeric(difftime(df_ped$ddate[df_ped$id %in% id],
df_ped$bdate[df_ped$id %in% id], unit="days"))/365.25),
as.numeric(difftime(df_ped$ddate[df_ped$id %in% id],
df_ped$bdate[df_ped$id %in% id], unit="days"))/365.25, 15),
ifelse(!is.na(as.numeric(difftime(df_ped$ddate[df_ped$id %in% id],
df_ped$bdate[df_ped$id %in% id], unit="days"))/365.25),
1, 0)) ~ 1)
tmp_sisters <- na.omit(unlist(lapply(id, kinlab::get_sisters, df_ped)))
cox_survival_f <- survival::coxph(survival::Surv(
ifelse(!is.na(as.numeric(difftime(df_ped$ddate[df_ped$id %in% tmp_sisters],
df_ped$bdate[df_ped$id %in% tmp_sisters], unit="days"))/365.25),
as.numeric(difftime(df_ped$ddate[df_ped$id %in% tmp_sisters],
df_ped$bdate[df_ped$id %in% tmp_sisters], unit="days"))/365.25, 15),
ifelse(!is.na(as.numeric(difftime(df_ped$ddate[df_ped$id %in% tmp_sisters],
df_ped$bdate[df_ped$id %in% tmp_sisters], unit="days"))/365.25),
1, 0)) ~ 1)
df_asfr <- kinlab::get_asfr(id, df_ped, evmat, evmat_bak)
df_life <- df_asfr
df_life$age1 <- as.numeric(substr(df_life$age, 1,2))
df_life$age2 <- df_life$age1 + 4
for (i in nrow(df_life)){
df_life$life.exp1[i] <- survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>df_life$age1[i]][1]
df_life$life.exp2[i] <- survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>df_life$age2[i]][1]
}
df_life$life.exp1[1] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>15][1]
df_life$life.exp2[1] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time ==
max(survival::basehaz(cox_survival_f)$time[survival::basehaz(cox_survival_f)$time<20])][1]
df_life$life.exp1[2] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>20][1]
df_life$life.exp2[2] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time ==
max(survival::basehaz(cox_survival_f)$time[survival::basehaz(cox_survival_f)$time<25])][1]
df_life$life.exp1[3] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>25][1]
df_life$life.exp2[3] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time ==
max(survival::basehaz(cox_survival_f)$time[survival::basehaz(cox_survival_f)$time<30])][1]
df_life$life.exp1[4] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>30][1]
df_life$life.exp2[4] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time ==
max(survival::basehaz(cox_survival_f)$time[survival::basehaz(cox_survival_f)$time<35])][1]
df_life$life.exp1[5] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>35][1]
df_life$life.exp2[5] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time ==
max(survival::basehaz(cox_survival_f)$time[survival::basehaz(cox_survival_f)$time<40])][1]
df_life$life.exp1[6] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>40][1]
df_life$life.exp2[6] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time ==
max(survival::basehaz(cox_survival_f)$time[survival::basehaz(cox_survival_f)$time<45])][1]
df_life$life.exp1[7] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time>45][1]
df_life$life.exp2[7] <- 1 - survival::basehaz(cox_survival_f)$hazard[survival::basehaz(cox_survival_f)$time ==
max(survival::basehaz(cox_survival_f)$time[survival::basehaz(cox_survival_f)$time<50])][1]
df_asfr$life.exp <- (df_life$life.exp1 + df_life$life.exp2)/2
df_asfr$cum.births <- cumsum(df_asfr$nbirth/df_asfr$nwomen)
basehaz_f <- data.frame(time=survival::survfit(cox_survival_f)$time, surv=survival::survfit(cox_survival_f)$surv)
basehaz_f_sample <- data.frame(time=survival::survfit(cox_survival_f_sample)$time, surv=survival::survfit(cox_survival_f_sample)$surv)
basehaz_f_sample$surv <- basehaz_f_sample$surv*min(basehaz_f[basehaz_f$time<15,"surv"])
basehaz_f <- rbind(basehaz_f[basehaz_f$time<min(survival::survfit(cox_survival_f_sample)$time),],basehaz_f_sample)
basehaz_f$rest.births[basehaz_f$time <15] <- sum(df_asfr$nbirth/df_asfr$nwomen)
basehaz_f$rest.births[basehaz_f$time>=15 & basehaz_f$time <20] <- sum(df_asfr$nbirth/df_asfr$nwomen)-df_asfr$nbirth[1]/df_asfr$nwomen[1]
basehaz_f$rest.births[basehaz_f$time>=20 & basehaz_f$time <25] <- sum(df_asfr$nbirth/df_asfr$nwomen)-df_asfr$nbirth[2]/df_asfr$nwomen[2]
basehaz_f$rest.births[basehaz_f$time>=25 & basehaz_f$time <30] <- sum(df_asfr$nbirth/df_asfr$nwomen)-df_asfr$nbirth[3]/df_asfr$nwomen[3]
basehaz_f$rest.births[basehaz_f$time>=30 & basehaz_f$time <35] <- sum(df_asfr$nbirth/df_asfr$nwomen)-df_asfr$nbirth[4]/df_asfr$nwomen[4]
basehaz_f$rest.births[basehaz_f$time>=35 & basehaz_f$time <40] <- sum(df_asfr$nbirth/df_asfr$nwomen)-df_asfr$nbirth[5]/df_asfr$nwomen[5]
basehaz_f$rest.births[basehaz_f$time>=30 & basehaz_f$time <45] <- sum(df_asfr$nbirth/df_asfr$nwomen)-df_asfr$nbirth[6]/df_asfr$nwomen[6]
basehaz_f$rest.births[basehaz_f$time>=45 & basehaz_f$time <50] <- sum(df_asfr$nbirth/df_asfr$nwomen)-df_asfr$nbirth[7]/df_asfr$nwomen[7]
basehaz_f$rest.births[basehaz_f$time >=50] <-0
basehaz_f$surv15 <-
ifelse(basehaz_f$time < 15, basehaz_f$surv[basehaz_f$time>15][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv20<-
ifelse(basehaz_f$time < 20, basehaz_f$surv[basehaz_f$time>20][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv25 <-
ifelse(basehaz_f$time < 25, basehaz_f$surv[basehaz_f$time>25][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv30 <-
ifelse(basehaz_f$time < 30, basehaz_f$surv[basehaz_f$time>30][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv35 <-
ifelse(basehaz_f$time < 35, basehaz_f$surv[basehaz_f$time>35][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv40 <-
ifelse(basehaz_f$time < 40, basehaz_f$surv[basehaz_f$time>40][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv45 <-
ifelse(basehaz_f$time < 45, basehaz_f$surv[basehaz_f$time>45][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv50 <-
ifelse(basehaz_f$time < 50, basehaz_f$surv[basehaz_f$time>50][1] +
1 - basehaz_f$surv, 1)
basehaz_f$surv[basehaz_f$time>15][1]
basehaz_f$nbirths.15 <- ifelse(basehaz_f$time < 20,
(ifelse(basehaz_f$time>15, 20-basehaz_f$time, 5))/5 * df_asfr$nbirth[1]/df_asfr$nwomen[1] *
basehaz_f$surv15, 0)
basehaz_f$nbirths.20 <- ifelse(basehaz_f$time < 25,
(ifelse(basehaz_f$time>20, 25-basehaz_f$time, 5))/5 * df_asfr$nbirth[2]/df_asfr$nwomen[2] *
basehaz_f$surv15, 0)
basehaz_f$nbirths.25 <- ifelse(basehaz_f$time < 30,
(ifelse(basehaz_f$time>25, 30-basehaz_f$time, 5))/5 * df_asfr$nbirth[3]/df_asfr$nwomen[3] *
basehaz_f$surv15, 0)
basehaz_f$nbirths.30 <- ifelse(basehaz_f$time < 35,
(ifelse(basehaz_f$time>30, 35-basehaz_f$time, 5))/5 * df_asfr$nbirth[4]/df_asfr$nwomen[4] *
basehaz_f$surv15, 0)
basehaz_f$nbirths.35 <- ifelse(basehaz_f$time < 40,
(ifelse(basehaz_f$time>35, 40-basehaz_f$time, 5))/5 * df_asfr$nbirth[5]/df_asfr$nwomen[5] *
basehaz_f$surv15, 0)
basehaz_f$nbirths.40 <- ifelse(basehaz_f$time < 45,
(ifelse(basehaz_f$time>40, 45-basehaz_f$time, 5))/5 * df_asfr$nbirth[6]/df_asfr$nwomen[6] *
basehaz_f$surv15, 0)
basehaz_f$nbirths.45 <- ifelse(basehaz_f$time < 50,
(ifelse(basehaz_f$time>45, 50-basehaz_f$time, 5))/5 * df_asfr$nbirth[7]/df_asfr$nwomen[7] *
basehaz_f$surv15, 0)
basehaz_f$resid.rv <-apply(basehaz_f[,c("nbirths.15", "nbirths.20",  "nbirths.25",  "nbirths.30",  "nbirths.35",  "nbirths.40",  "nbirths.45")], 1, sum)
basehaz_f$n.surv <-apply(basehaz_f[,c("surv15", "surv20",  "surv25",  "surv30",  "surv35",  "surv40",  "surv45")], 1, sum)
basehaz_f$resid.rv[basehaz_f$time==max(basehaz_f$time[basehaz_f$time<=age])]
df_xs <- data.frame(momid = unique(kh.data::kh_ind$momid[kh.data::kh_ind$momid>0]), tmp = NA)
df_xs$twinmother <- ifelse(df_xs$momid %in% twinmom_id, 1, 0)
kinlab::get_twinmothers
kinlab::get_twinmothers(kh.data::kh_ind)
str(kh.data::kh_ind)
kinlab::get_twinmothers(df = kh.data::kh_ind)
kinlab::get_twinmothers(kh.data::kh_ind)
kinlab::get_twinmothers(
kinlab::get_twinmothers
df_xs <- data.frame(momid = unique(kh.data::kh_ind$momid[kh.data::kh_ind$momid>0]), tmp = NA)
df_xs$twinmother <- ifelse(df_xs$momid %in% kinlab::get_twinmothers(kh.data::kh_ind, var_bdate="bdate", var_mother="momid"), 1, 0)
df=df_xs
momid = "momid"
var = "twinmother"
df_ped ?= kh_ind
evmat = kh_mat
evmat_bak = kkh_mat
action = "make.plot"
df=df_xs
momid = "momid"
var = "twinmother"
df_ped = kh.data::kh_ind
evmat = kh.data::kh_mat
evmat_bak = kh.data::kh_mat
action = "make.plot"
if(is.null(categories)){
dfresid <- unlist_df(tapply( df[,paste(momid)], factor(df[,paste(var)]), get_resid_rv, df_ped, evmat, evmat_bak))
} else dfresid <- unlist_df(tapply( df[,paste(momid)], categorize(df[,paste(var)],
categories), get_resid_rv, df_ped, evmat, evmat_bak))
dfresid <- subset(dfresid, time < 50)
if(action=="make.plot"){
myplot <- ggplot2::qplot(time, resid.rv, data = dfresid, geom="smooth", method = "loess", span = 0.25, level = 0.99, colour = dflist,
ylim = c(ifelse(is.null(y.lim), 0, y.lim[1]), ifelse(is.null(y.lim), 1+ceiling(max(dfresid$resid.rv)) , y.lim[2]))) +
ggplot2::xlab("Age (years)") + ggplot2::ylab("Residual reproductive value") + ggplot2::geom_point() + ggplot2::theme(legend.position="right",
#             legend.direction="horizontal",
legend.title =  ggplot2::element_blank())
print(myplot)
}
if(action=="return.df"){return(dfresid)}
if(action=="return.plot"){
return(
ggplot2::qplot(time, resid.rv, data = dfresid, geom="smooth", method = "loess",span = 0.25,  level = 0.99, colour = dflist,
ylim = c(ifelse(is.null(y.lim), 0, y.lim[1]), ifelse(is.null(y.lim), 1+ ceiling(max(dfresid$resid.rv)) , y.lim[2]))) +
ggplot2::ylab("Residual reproductive value") + ggplot2::geom_point() + ggplot2::theme(legend.position="right",
#                                                  legend.direction="horizontal",
legend.title = ggplot2::element_blank()))}
categories=NULL
if(is.null(categories)){
dfresid <- unlist_df(tapply( df[,paste(momid)], factor(df[,paste(var)]), get_resid_rv, df_ped, evmat, evmat_bak))
} else dfresid <- unlist_df(tapply( df[,paste(momid)], categorize(df[,paste(var)],
categories), get_resid_rv, df_ped, evmat, evmat_bak))
if(is.null(categories)){
dfresid <- kinlab::unlist_df(tapply( df[,paste(momid)], factor(df[,paste(var)]), get_resid_rv, df_ped, evmat, evmat_bak))
} else dfresid <- kinlab::unlist_df(tapply( df[,paste(momid)], categorize(df[,paste(var)],
categories), get_resid_rv, df_ped, evmat, evmat_bak))
if(is.null(categories)){
dfresid <- kinlab::unlist_df(tapply( df[,paste(momid)], factor(df[,paste(var)]), kinlab::get_resid_rv, df_ped, evmat, evmat_bak))
} else dfresid <- kinlab::unlist_df(tapply( df[,paste(momid)], kinlab::categorize(df[,paste(var)],
categories), kinlab::get_resid_rv, df_ped, evmat, evmat_bak))
dfresid <- subset(dfresid, time < 50)
library(kinlab)
if(is.null(categories)){
dfresid <- kinlab::unlist_df(tapply( df[,paste(momid)], factor(df[,paste(var)]), kinlab::get_resid_rv, df_ped, evmat, evmat_bak))
} else dfresid <- kinlab::unlist_df(tapply( df[,paste(momid)], kinlab::categorize(df[,paste(var)],
categories), kinlab::get_resid_rv, df_ped, evmat, evmat_bak))
dfresid <- subset(dfresid, time < 50)
library(kh.data)
source('~/.active-rstudio-document', echo=TRUE)
kinlab::plot_rrv(df=df_xs,
momid = "momid",
var="twinmother",
kh.data::kh_ind, kh.data::kh_mat, kh.data::kh_mat,
categories=NULL,
action = "make.plot",
y.lim=NULL)
source('~/.active-rstudio-document', echo=TRUE)
